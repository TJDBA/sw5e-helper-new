{{!-- templates/cards/attack-card.hbs - Improved Attack Card --}}
<div class="sw5e-helper-card" data-message-id="{{messageId}}">
  <div class="card-header">
    <div class="weapon-banner">
      <img src="{{weaponImg}}" alt="{{weaponName}}" class="weapon-icon" />
      <div class="weapon-title">
        <span class="name">{{weaponName}}</span>
      </div>
    </div>
    {{#if attackInfo}}
    <span class="info-icon" data-action="show-attack-formula" title="{{localize "SW5EHELPER.AttackFormulaTooltip"}}">‚ìò</span>
    {{/if}}
  </div>
  
  <div class="card-controls">
    <div class="damage-controls">
      {{#unless hideQuickDamage}}
      <button class="quick-btn" data-action="card-quick-damage" title="{{localize "SW5EHELPER.QuickDamage"}}">‚ö° Quick</button>
      {{/unless}}
      {{#unless hideModDamage}}
      <button class="quick-btn" data-action="card-mod-damage" title="{{localize "SW5EHELPER.ModDamage"}}">üé≤ Modify</button>
      {{/unless}}
    </div>
    
    {{#if isGM}}
    <div class="gm-toolbar">
      {{#unless hideRollAllSaves}}
      <button class="gm-btn" data-action="gm-roll-all-saves">{{localize "SW5EHELPER.RollAllSaves"}}</button>
      {{/unless}}
      <button class="gm-btn" data-action="gm-apply-all-full">{{localize "SW5EHELPER.ApplyAllFull"}}</button>
    </div>
    {{/if}}
    
    <button class="gm-btn toggle-all-btn" data-action="toggle-all">
      {{#if expandedAll}}{{localize "SW5EHELPER.CollapseAll"}}{{else}}{{localize "SW5EHELPER.ExpandAll"}}{{/if}}
    </button>
  </div>

  <div class="target-rows">
    {{#each targets}}
    <details class="target-row{{#if missing}} missing{{/if}}" data-target-ref="{{ref}}" {{#if ../expandedAll}}open{{/if}}>
      <summary class="summary-row" data-action="toggle-details">
        <span class="expand-arrow">‚ñ∂</span>
        <img class="portrait" src="{{img}}" alt="{{name}}" />
        <span class="tname" data-action="{{#if canControl}}select-token{{else}}ping-token{{/if}}" data-target-ref="{{ref}}">{{name}}</span>
        
        {{#if ../saveOnly}}
        <span class="save-summary">
          {{#if saveAbility}}{{saveAbility}}{{else}}SAVE{{/if}} DC {{#if saveDC}}{{saveDC}}{{else}}‚Äî{{/if}}
          {{#if saveResult}} | {{saveResult.total}} {{saveResult.icon}}{{/if}}
        </span>
        {{else}}
        <span class="attack-total">{{attackDisplay}} <span class="status-icon {{statusClass}}" title="{{statusText}}">{{statusIcon}}</span></span>
        <span class="damage-summary">{{damageDisplay}}</span>
        {{/if}}
        
        <span class="row-actions{{#if damageApplied}} applied{{/if}}">
          {{#if damageApplied}}
          ‚úì {{#if damageInfo}}<span class="info-icon" data-action="show-damage-formula" data-target-ref="{{ref}}" title="{{localize "SW5EHELPER.DamageFormulaTooltip"}}">‚ìò</span>{{/if}}
          {{else if damageTotal}}
          <a class="action-btn" data-action="apply-full" title="{{localize "SW5EHELPER.ApplyFull"}}" data-target-ref="{{ref}}">üíØ</a>
          <a class="action-btn" data-action="apply-half" title="{{localize "SW5EHELPER.ApplyHalf"}}" data-target-ref="{{ref}}">¬Ω</a>
          {{#if damageInfo}}<span class="info-icon" data-action="show-damage-formula" data-target-ref="{{ref}}" title="{{localize "SW5EHELPER.DamageFormulaTooltip"}}">‚ìò</span>{{/if}}
          {{/if}}
          {{#if missing}}<span class="missing">[{{localize "SW5EHELPER.Missing"}}]</span>{{/if}}
        </span>
      </summary>
      
      <div class="row-body">
        {{#if ../hasSave}}
        {{#if showSave}}
        <div class="save-line">
          <span class="detail-label">üõ°Ô∏è {{saveAbility}} | DC: 
            <span class="save-dc" {{#if saveFormula}}title="{{saveFormula}}"{{/if}}>{{saveDC}}</span>
          </span>
          {{#if saveResult}}
          <span class="save-result">{{saveResult.total}} {{saveResult.icon}}</span>
          {{else}}
          <button class="gm-btn" data-action="roll-save" data-target-ref="{{ref}}">{{localize "SW5EHELPER.RollSave"}}</button>
          {{/if}}
        </div>
        {{/if}}
        {{/if}}
        
        <div class="damage-line">
          <span class="detail-label">üí• {{localize "SW5EHELPER.Damage"}}: <span class="dmg-val">{{#if damageTotal}}{{damageTotal}}{{else}}‚Äî{{/if}}</span></span>
          {{#if damageApplied}}
          <span class="applied-tag">[{{uppercase damageApplied}}]</span>
          {{else if damageTotal}}
          <div class="damage-controls">
            <a class="action-btn" data-action="row-mod-damage" data-target-ref="{{ref}}" title="{{localize "SW5EHELPER.ModDamage"}}">üé≤</a>
            <a class="action-btn" data-action="apply-full" data-target-ref="{{ref}}" title="{{localize "SW5EHELPER.ApplyFull"}}">üíØ</a>
            <a class="action-btn" data-action="apply-half" data-target-ref="{{ref}}" title="{{localize "SW5EHELPER.ApplyHalf"}}">¬Ω</a>
            <a class="action-btn" data-action="apply-none" data-target-ref="{{ref}}" title="{{localize "SW5EHELPER.ApplyNone"}}">√ò</a>
          </div>
          {{/if}}
          {{#if damageInfo}}
          <span class="info-icon" data-action="show-damage-formula" data-target-ref="{{ref}}" title="{{localize "SW5EHELPER.DamageFormulaTooltip"}}">‚ìò</span>
          {{/if}}
        </div>
      </div>
    </details>
    {{/each}}
  </div>
</div>